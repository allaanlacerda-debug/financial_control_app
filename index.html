<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FinApp – Recuperação Financeira</title>
<style>
:root{
  --bg:#0b1220; --fg:#e5e7eb; --muted:#9ca3af; --card:#111827;
  --primary:#2563eb; --success:#16a34a; --warn:#f59e0b; --danger:#dc2626;
  --light:#f8fafc;
}
*{box-sizing:border-box}
body{margin:0;font:14px/1.4 system-ui,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--fg)}
header{position:sticky;top:0;background:#0b1220f0;backdrop-filter:saturate(140%) blur(4px);z-index:5}
.container{max-width:1100px;margin:0 auto;padding:16px}
h1{font-size:20px;margin:8px 0 12px}
nav{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border:1px solid #233047;border-radius:8px;color:var(--fg);cursor:pointer;background:transparent}
.tab.active{background:var(--primary);border-color:var(--primary)}
.grid{display:grid;gap:12px}
.kpis{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.card{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:12px}
.card h3{margin:0 0 8px;font-size:14px;color:#cbd5e1}
.kpi{font-size:22px;font-weight:700}
.sub{color:var(--muted);font-size:12px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.row > *{flex:1}
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #253244;background:#0f172a;color:var(--fg)}
label{font-size:12px;color:#cbd5e1}
button{padding:10px 12px;border-radius:10px;border:1px solid #233047;background:#162338;color:#e5e7eb;cursor:pointer}
button.primary{background:var(--primary);border-color:var(--primary)}
button.ghost{background:transparent}
button.success{background:var(--success);border-color:var(--success)}
button.warn{background:var(--warn);border-color:var(--warn)}
button.danger{background:var(--danger);border-color:var(--danger)}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #1f2937;padding:8px;text-align:left}
.badge{padding:3px 8px;border-radius:999px;font-size:11px}
.badge.green{background:#063; color:#c6f6d5}
.badge.yellow{background:#7a5b00;color:#fde68a}
.badge.red{background:#5b1111;color:#fecaca}
.right{float:right}
small.help{color:var(--muted);display:block;margin-top:4px}
hr{border:0;border-top:1px solid #1f2937;margin:12px 0}
.footer{color:var(--muted);text-align:center;padding:24px 0}
ul.clean{margin:0;padding-left:16px}
canvas{width:100%;height:180px;background:#0f172a;border-radius:10px}
.hidden{display:none}
@media (max-width:600px){ .row>*{flex:100%} }
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>FinApp – Recuperação Financeira</h1>
    <nav id="tabs"></nav>
  </div>
</header>

<main class="container">
  <!-- DASHBOARD -->
  <section id="tab-dashboard" class="tabpane">
    <div class="grid kpis">
      <div class="card">
        <h3>Saldo Devedor Total</h3>
        <div class="kpi" id="kpi-total-debt">R$ 0,00</div>
        <div class="sub" id="kpi-trend">Evolução: —</div>
      </div>
      <div class="card">
        <h3>Próximo Vencimento Crítico</h3>
        <div class="kpi" id="kpi-next-due">—</div>
        <div class="sub" id="kpi-next-due-sub">—</div>
      </div>
      <div class="card">
        <h3>% Renda Comprometida</h3>
        <div class="kpi" id="kpi-prc">—</div>
        <div class="sub" id="kpi-prc-sub">Limite: —</div>
      </div>
      <div class="card">
        <h3>Progresso das Metas</h3>
        <div class="kpi" id="kpi-goals">—</div>
        <div class="sub" id="kpi-goals-sub">—</div>
      </div>
    </div>

    <div class="grid" style="grid-template-columns:1.2fr .8fr; margin-top:12px;">
      <div class="card">
        <h3>Gasto vs. Renda (mês)</h3>
        <canvas id="chart-spend"></canvas>
        <div class="sub" id="spend-legend">—</div>
      </div>
      <div class="card">
        <h3>Alertas</h3>
        <ul id="alerts" class="clean"></ul>
      </div>
    </div>
  </section>

  <!-- DÍVIDAS -->
  <section id="tab-dividas" class="tabpane hidden">
    <div class="card">
      <h3>Cadastrar/Editar Dívida</h3>
      <div class="row">
        <div><label>Tipo</label><select id="debt-type">
          <option>cartao</option><option>emprestimo</option><option>conta_atraso</option></select></div>
        <div><label>Credor</label><input id="debt-creditor" placeholder="Banco X"/></div>
        <div><label>Saldo (R$)</label><input id="debt-out" type="number" min="0" step="0.01"/></div>
        <div><label>Juros a.m. (%)</label><input id="debt-int" type="number" min="0" step="0.01" placeholder="ex.: 12"/></div>
        <div><label>Vencimento</label><input id="debt-due" type="date"/></div>
        <div><label>Risco de negativação?</label><select id="debt-risk"><option value="false">Não</option><option value="true">Sim</option></select></div>
      </div>
      <small class="help">Regra de parcela mínima (estimada): 5% do saldo (mín. R$50).</small>
      <div class="row">
        <button class="primary" id="btn-add-debt">Salvar Dívida</button>
        <button class="ghost" id="btn-clear-debt">Limpar</button>
      </div>
    </div>

    <div class="card">
      <h3>Minhas Dívidas</h3>
      <table id="tbl-debts">
        <thead><tr>
          <th>Tipo</th><th>Credor</th><th>Saldo</th><th>Juros a.m.</th><th>Vencimento</th><th>Status</th><th>Ações</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- RENDA & REGRAS -->
  <section id="tab-regras" class="tabpane hidden">
    <div class="card">
      <h3>Renda e Regras</h3>
      <div class="row">
        <div><label>Renda mensal líquida (R$)</label><input id="income" type="number" min="0" step="0.01"/></div>
        <div><label>Limite de gastos mensais (R$)</label><input id="limit-spend" type="number" min="0" step="0.01"/></div>
        <div><label>% máx. renda comprometida</label><input id="max-prc" type="number" min="0" max="100" step="1" value="50"/></div>
        <div><label>Estrategia de priorização</label>
          <select id="strategy"><option value="hybrid">Híbrida (risco→juros→saldo)</option>
            <option value="avalanche">Avalanche (maior juros)</option>
            <option value="snowball">Snowball (menor saldo)</option></select>
        </div>
      </div>
      <div class="row">
        <button class="primary" id="btn-save-rules">Salvar Regras</button>
      </div>
    </div>
  </section>

  <!-- GASTOS -->
  <section id="tab-gastos" class="tabpane hidden">
    <div class="card">
      <h3>Registrar gasto</h3>
      <div class="row">
        <div><label>Valor (R$)</label><input id="exp-amt" type="number" step="0.01"/></div>
        <div><label>Categoria</label>
          <select id="exp-cat">
            <option>Alimentação</option><option>Transporte</option><option>Lazer</option>
            <option>Contas Fixas</option><option>Saúde</option><option>Educação</option>
            <option>Outros</option>
          </select>
        </div>
        <div><label>Método</label><select id="exp-method"><option>debito</option><option>credito</option></select></div>
        <div><label>Data</label><input id="exp-date" type="date"/></div>
        <div><label>Nota</label><input id="exp-note" placeholder="opcional"/></div>
      </div>
      <div class="row">
        <button class="primary" id="btn-add-exp">Adicionar</button>
      </div>
    </div>

    <div class="card">
      <h3>Gastos do mês</h3>
      <table id="tbl-exp">
        <thead><tr><th>Data</th><th>Valor</th><th>Categoria</th><th>Método</th><th>Nota</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- METAS -->
  <section id="tab-metas" class="tabpane hidden">
    <div class="card">
      <h3>Nova/Editar Meta</h3>
      <div class="row">
        <div><label>Nome</label><input id="goal-name" placeholder="Reserva de Emergência"/></div>
        <div><label>Valor alvo (R$)</label><input id="goal-target" type="number" step="0.01"/></div>
        <div><label>Prazo</label><input id="goal-date" type="date"/></div>
      </div>
      <div class="row">
        <button class="primary" id="btn-add-goal">Salvar Meta</button>
        <button class="ghost" id="btn-clear-goal">Limpar</button>
      </div>
    </div>

    <div class="card">
      <h3>Metas</h3>
      <table id="tbl-goals">
        <thead><tr><th>Meta</th><th>Alvo</th><th>Prazo</th><th>Poup. sugerida/mês</th><th>Progresso</th><th>Ações</th></tr></thead>
        <tbody></tbody>
      </table>
      <hr/>
      <div id="goal-plan" class="sub">Selecione uma meta para ver o plano de ação.</div>
    </div>
  </section>

  <!-- RELATÓRIOS / EXPORTAR -->
  <section id="tab-relatorios" class="tabpane hidden">
    <div class="grid" style="grid-template-columns:1fr 1fr;">
      <div class="card">
        <h3>Para onde vai seu dinheiro (mês)</h3>
        <canvas id="chart-cats"></canvas>
        <div class="sub" id="cats-legend">—</div>
      </div>
      <div class="card">
        <h3>Projeção de Recuperação (simplificada)</h3>
        <canvas id="chart-proj"></canvas>
        <div class="sub" id="proj-legend">Assume parcela mínima + extra disponível.</div>
      </div>
    </div>
    <div class="card">
      <h3>Backup</h3>
      <div class="row">
        <button id="btn-export" class="success">Exportar JSON</button>
        <input type="file" id="file-import" accept="application/json"/>
        <button id="btn-import" class="primary">Importar</button>
        <button id="btn-reset" class="danger right">Apagar tudo</button>
      </div>
      <small class="help">Dica: exporte periodicamente para manter um backup.</small>
    </div>
  </section>

  <div class="footer">Feito com ♥ • Seus dados ficam no seu navegador (LocalStorage)</div>
</main>

<script>
/*** ===== Estado & Persistência ===== ***/
const KEY='finapp_v1';
const todayStr=()=>new Date().toISOString().slice(0,10);
const state = load() || seed();

function seed(){
  const now = new Date();
  const nextMonth = new Date(now.getFullYear(), now.getMonth()+1, 5);
  return {
    rules:{ income:4000, limitSpend:3000, maxPrc:50, strategy:'hybrid' },
    debts:[
      {id:id(), type:'cartao', creditor:'Banco X', outstanding:3200, interest:0.15, due:fmtDate(nextMonth), status:'open', risk:true},
      {id:id(), type:'emprestimo', creditor:'Financeira Y', outstanding:8500, interest:0.06, due:fmtDate(new Date(now.getFullYear(), now.getMonth()+1, 12)), status:'open', risk:false}
    ],
    expenses:[],
    goals:[],
    history:[]
  };
}
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function load(){ try{ return JSON.parse(localStorage.getItem(KEY)); }catch(e){ return null; } }
function id(){ return Math.random().toString(36).slice(2,10); }
function fmtBR(v){ return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function fmtNum(v){ return Number(v||0); }
function fmtDate(d){ if(typeof d==='string') return d; return d.toISOString().slice(0,10); }
function parseDate(s){ return new Date(s+'T00:00:00'); }
function monthKey(dt=new Date()){ return dt.toISOString().slice(0,7); }

/*** ===== UI: Tabs ===== ***/
const tabList = [
  ['dashboard','Dashboard'],
  ['dividas','Dívidas'],
  ['regras','Renda & Regras'],
  ['gastos','Gastos'],
  ['metas','Metas'],
  ['relatorios','Relatórios/Backup'],
];
const tabsEl=document.getElementById('tabs');
tabList.forEach(([k,label],i)=>{
  const b=document.createElement('button');
  b.className='tab'+(i===0?' active':'');
  b.textContent=label;
  b.onclick=()=>switchTab(k);
  b.id='btn-tab-'+k;
  tabsEl.appendChild(b);
});
function switchTab(k){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('btn-tab-'+k).classList.add('active');
  document.querySelectorAll('.tabpane').forEach(p=>p.classList.add('hidden'));
  document.getElementById('tab-'+k).classList.remove('hidden');
  render(); // atualizar KPIs/gráficos ao trocar
}

/*** ===== Regras ===== ***/
const incomeEl = document.getElementById('income');
const limitEl = document.getElementById('limit-spend');
const maxPrcEl = document.getElementById('max-prc');
const stratEl = document.getElementById('strategy');
document.getElementById('btn-save-rules').onclick=()=>{
  state.rules.income=fmtNum(incomeEl.value);
  state.rules.limitSpend=fmtNum(limitEl.value);
  state.rules.maxPrc=fmtNum(maxPrcEl.value);
  state.rules.strategy=stratEl.value;
  save(); toast('Regras salvas.');
  render();
};

/*** ===== Dívidas ===== ***/
const debtFields = {
  type:document.getElementById('debt-type'),
  creditor:document.getElementById('debt-creditor'),
  out:document.getElementById('debt-out'),
  int:document.getElementById('debt-int'),
  due:document.getElementById('debt-due'),
  risk:document.getElementById('debt-risk')
};
let editingDebtId=null;

document.getElementById('btn-add-debt').onclick=()=>{
  const d={
    id: editingDebtId || id(),
    type: debtFields.type.value,
    creditor: debtFields.creditor.value||'—',
    outstanding: fmtNum(debtFields.out.value),
    interest: fmtNum(debtFields.int.value)/100 || 0,
    due: debtFields.due.value || todayStr(),
    status:'open',
    risk: debtFields.risk.value==='true'
  };
  if(editingDebtId){
    const i=state.debts.findIndex(x=>x.id===editingDebtId);
    state.debts[i]=d; editingDebtId=null;
  }else{
    state.debts.push(d);
  }
  clearDebtForm(); save(); renderDebts(); render();
};
document.getElementById('btn-clear-debt').onclick=()=>{ editingDebtId=null; clearDebtForm(); };
function clearDebtForm(){ Object.values(debtFields).forEach(el=>el.value=''); debtFields.type.value='cartao'; debtFields.risk.value='false'; }

function minPayment(debt){ return Math.min(debt.outstanding, Math.max(50, debt.outstanding*0.05)); }
function markPaid(id, mode='partial'){
  const d=state.debts.find(x=>x.id===id); if(!d) return;
  let amt = mode==='full' ? d.outstanding : prompt('Valor pago (R$):', minPayment(d));
  if(amt===null) return; amt = fmtNum(amt);
  d.outstanding = Math.max(0, d.outstanding - amt);
  if(d.outstanding<=0.009){ d.outstanding=0; d.status='settled'; }
  save(); renderDebts(); render();
}
function editDebt(id){
  const d=state.debts.find(x=>x.id===id); if(!d) return;
  editingDebtId=id;
  debtFields.type.value=d.type;
  debtFields.creditor.value=d.creditor;
  debtFields.out.value=d.outstanding;
  debtFields.int.value=(d.interest*100).toFixed(2);
  debtFields.due.value=d.due;
  debtFields.risk.value=String(d.risk);
  window.scrollTo({top:0,behavior:'smooth'});
}
function removeDebt(id){
  if(!confirm('Remover dívida?')) return;
  state.debts=state.debts.filter(x=>x.id!==id); save(); renderDebts(); render();
}

/*** ===== Gastos ===== ***/
document.getElementById('exp-date').value=todayStr();
document.getElementById('btn-add-exp').onclick=()=>{
  const e={
    id:id(), value:fmtNum(document.getElementById('exp-amt').value||0),
    cat:document.getElementById('exp-cat').value,
    method:document.getElementById('exp-method').value,
    date: document.getElementById('exp-date').value || todayStr(),
    note: document.getElementById('exp-note').value||''
  };
  if(e.value<=0){ alert('Informe um valor.'); return;}
  state.expenses.push(e); save(); renderExpenses(); render();
  document.getElementById('exp-amt').value=''; document.getElementById('exp-note').value='';
};
function removeExp(id){ state.expenses=state.expenses.filter(x=>x.id!==id); save(); renderExpenses(); render(); }

/*** ===== Metas ===== ***/
let editingGoalId=null;
document.getElementById('btn-add-goal').onclick=()=>{
  const g={
    id: editingGoalId || id(),
    name: document.getElementById('goal-name').value||'Meta',
    target: fmtNum(document.getElementById('goal-target').value||0),
    date: document.getElementById('goal-date').value || todayStr(),
    saved: 0
  };
  if(editingGoalId){
    const i=state.goals.findIndex(x=>x.id===editingGoalId);
    state.goals[i]=g; editingGoalId=null;
  }else{ state.goals.push(g); }
  clearGoalForm(); save(); renderGoals(); render();
};
document.getElementById('btn-clear-goal').onclick=()=>{ editingGoalId=null; clearGoalForm(); };
function clearGoalForm(){ ['goal-name','goal-target','goal-date'].forEach(id=>document.getElementById(id).value=''); }

function editGoal(id){
  const g=state.goals.find(x=>x.id===id); if(!g) return;
  editingGoalId=id;
  document.getElementById('goal-name').value=g.name;
  document.getElementById('goal-target').value=g.target;
  document.getElementById('goal-date').value=g.date;
  window.scrollTo({top:0,behavior:'smooth'});
}
function removeGoal(id){ if(!confirm('Remover meta?')) return; state.goals=state.goals.filter(x=>x.id!==id); save(); renderGoals(); render(); }
function addGoalSaving(id){
  const g=state.goals.find(x=>x.id===id); if(!g) return;
  let amt = prompt('Quanto deseja registrar de poupança para esta meta (R$)?','100');
  if(amt===null) return; g.saved+=fmtNum(amt); if(g.saved>g.target) g.saved=g.target;
  save(); renderGoals(); render();
}

/*** ===== Lógica de Prioridade / Projeção ===== ***/
function prioritizeDebts(list, refDate=new Date()){
  const arr=list.filter(d=>d.status!=='settled').slice();
  const strat=state.rules.strategy||'hybrid';
  arr.sort((a,b)=>{
    const ad=daysToDue(a.due, refDate), bd=daysToDue(b.due, refDate);
    const riskScore = (x,dx)=> (x.status==='overdue'||dx<0?2:0)+(x.risk?1:0);
    if(strat==='hybrid'){
      const r = riskScore(b,bd)-riskScore(a,ad); if(r) return r;
      const j = b.interest - a.interest; if(j) return j>0?1:-1;
      return a.outstanding-b.outstanding;
    }
    if(strat==='avalanche'){ const j=b.interest-a.interest; if(j) return j>0?1:-1; return a.outstanding-b.outstanding; }
    if(strat==='snowball'){ return a.outstanding-b.outstanding; }
    return 0;
  });
  return arr;
}
function daysToDue(due, ref=new Date()){ return Math.ceil((parseDate(due)-ref)/86400000); }

function simulate(months=6){
  const ref = new Date(); const income=fmtNum(state.rules.income);
  // Essenciais = gastos de categorias Contas Fixas + Alimentação + Saúde (mês atual)
  const mkey=monthKey(ref);
  const monthExps = state.expenses.filter(e=>monthKey(parseDate(e.date))===mkey);
  const essentials = monthExps.filter(e=>['Contas Fixas','Alimentação','Saúde'].includes(e.cat))
                              .reduce((s,e)=>s+e.value,0);
  let debts = state.debts.map(d=>({...d})); // clone
  const series=[{label:'Saldo total',value:debts.reduce((s,d)=>s+d.outstanding,0)}];

  for(let m=1;m<=months;m++){
    // mínimos + excedente
    const minSum = debts.filter(d=>d.status!=='settled').reduce((s,d)=>s+minPayment(d),0);
    const capacity = Math.max(0, income - (essentials + minSum));
    let buffer = capacity;
    const ordered = prioritizeDebts(debts, new Date(ref.getFullYear(), ref.getMonth()+m, 1));
    ordered.forEach(d=>{
      if(d.status==='settled') return;
      const interestAmt = d.outstanding * (d.interest||0);
      let pay = minPayment(d);
      let extra = Math.min(buffer, Math.max(0, d.outstanding + interestAmt - pay));
      buffer -= extra;
      const newOut = Math.max(0, d.outstanding + interestAmt - (pay+extra));
      d.outstanding = newOut;
      if(newOut<=0.009) d.status='settled';
    });
    series.push({label:`M${m}`,value:debts.reduce((s,d)=>s+d.outstanding,0)});
  }
  return series;
}

/*** ===== KPIs, Tabelas e Gráficos ===== ***/
function render(){
  // Regras form
  incomeEl.value=state.rules.income||0;
  limitEl.value=state.rules.limitSpend||0;
  maxPrcEl.value=state.rules.maxPrc||50;
  stratEl.value=state.rules.strategy||'hybrid';

  // KPIs
  const openDebts = state.debts.filter(d=>d.status!=='settled');
  const totalDebt = openDebts.reduce((s,d)=>s+d.outstanding,0);
  document.getElementById('kpi-total-debt').textContent=fmtBR(totalDebt);

  // Próximo vencimento
  const upcoming = openDebts
    .slice().sort((a,b)=>parseDate(a.due)-parseDate(b.due));
  const next = upcoming[0];
  document.getElementById('kpi-next-due').textContent = next? new Date(next.due).toLocaleDateString('pt-BR'):'—';
  document.getElementById('kpi-next-due-sub').textContent = next? `${next.creditor} • ${fmtBR(next.outstanding)}`:'—';

  // PRC
  const mkey=monthKey(new Date());
  const monthExps = state.expenses.filter(e=>monthKey(parseDate(e.date))===mkey);
  const essentials = monthExps.filter(e=>['Contas Fixas','Alimentação','Saúde'].includes(e.cat))
                              .reduce((s,e)=>s+e.value,0);
  const minDebts = openDebts.reduce((s,d)=>s+minPayment(d),0);
  const income=fmtNum(state.rules.income);
  const prc = income<=0?1:( (minDebts + essentials) / income );
  const prcPct = (prc*100);
  const prcStr = isFinite(prcPct)? prcPct.toFixed(0)+'%':'—';
  document.getElementById('kpi-prc').textContent = prcStr;
  document.getElementById('kpi-prc-sub').textContent = `Limite: ${state.rules.maxPrc||0}%`;
  document.getElementById('kpi-prc').style.color = prcPct<=30?'#a7f3d0':(prcPct<=50?'#fde68a':'#fecaca');

  // Metas KPI
  const goals = state.goals;
  let onTrack=0;
  goals.forEach(g=>{
    const monthsLeft = Math.max(1, monthDiff(new Date(), parseDate(g.date)));
    const need = Math.max(0, g.target - g.saved)/monthsLeft;
    const capacity = Math.max(0, income - (state.rules.limitSpend||0));
    if(need <= capacity) onTrack++;
  });
  document.getElementById('kpi-goals').textContent = goals.length? `${onTrack}/${goals.length} on track`:'—';
  document.getElementById('kpi-goals-sub').textContent = goals.length? 'Metas viáveis considerando limite e renda':'Crie sua primeira meta';

  // Alerts
  renderAlerts();

  // Charts
  drawSpendVsIncome(monthExps, income, state.rules.limitSpend||0);
  drawCatsChart(monthExps);
  drawProjectionChart(simulate(6));

  // Tables
  renderDebts();
  renderExpenses();
  renderGoals();
}
function monthDiff(a,b){ return (b.getFullYear()-a.getFullYear())*12 + (b.getMonth()-a.getMonth()); }

function renderAlerts(){
  const list=document.getElementById('alerts'); list.innerHTML='';
  const ref=new Date();
  const items=[];
  state.debts.filter(d=>d.status!=='settled').forEach(d=>{
    const days=daysToDue(d.due,ref);
    if(days<0) items.push({kind:'Atraso',msg:`${d.creditor} vencida há ${Math.abs(days)} dia(s).`, severity:'red'});
    else if(days<=7) items.push({kind:'Vencimento',msg:`${d.creditor} vence em ${days} dia(s).`, severity:'yellow'});
    if(d.risk) items.push({kind:'Negativação',msg:`Risco com ${d.creditor}. Priorize.`, severity:'red'});
  });
  const mkey=monthKey(ref);
  const monthExps = state.expenses.filter(e=>monthKey(parseDate(e.date))===mkey)
  const totalMonth = monthExps.reduce((s,e)=>s+e.value,0);
  if(state.rules.limitSpend && totalMonth>state.rules.limitSpend)
    items.push({kind:'Limite',msg:`Gastos do mês acima do limite (${fmtBR(totalMonth)}).`,severity:'yellow'});
  const prcText=document.getElementById('kpi-prc').textContent.replace('%','')||'0';
  if(Number(prcText)>state.rules.maxPrc) items.push({kind:'Comprometimento', msg:'% da renda comprometida acima do limite.', severity:'red'});

  if(items.length===0){ list.innerHTML='<li class="sub">Sem alertas no momento.</li>'; return; }
  items.forEach(a=>{
    const li=document.createElement('li');
    li.innerHTML=`<span class="badge ${a.severity==='red'?'red':'yellow'}">${a.kind}</span> ${a.msg}`;
    list.appendChild(li);
  });
}

function renderDebts(){
  const tbody=document.querySelector('#tbl-debts tbody'); tbody.innerHTML='';
  const rows = state.debts.slice().sort((a,b)=>parseDate(a.due)-parseDate(b.due));
  rows.forEach(d=>{
    const tr=document.createElement('tr');
    const status = d.status==='settled'?'Quitada': (daysToDue(d.due)<0?'Atrasada':'Ativa');
    tr.innerHTML=`
      <td>${d.type}</td>
      <td>${d.creditor}</td>
      <td>${fmtBR(d.outstanding)}</td>
      <td>${(d.interest*100).toFixed(2)}%</td>
      <td>${new Date(d.due).toLocaleDateString('pt-BR')}</td>
      <td>${status} ${d.risk?'<span class="badge red">risco</span>':''}</td>
      <td>
        ${d.status!=='settled'?`
          <button class="success" onclick="markPaid('${d.id}','partial')">Pagar</button>
          <button class="warn" onclick="markPaid('${d.id}','full')">Quitar</button>`:''}
        <button onclick="editDebt('${d.id}')">Editar</button>
        <button class="danger" onclick="removeDebt('${d.id}')">Remover</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function renderExpenses(){
  const tbody=document.querySelector('#tbl-exp tbody'); tbody.innerHTML='';
  const mkey=monthKey(new Date());
  const rows = state.expenses.filter(e=>monthKey(parseDate(e.date))===mkey)
               .sort((a,b)=>parseDate(b.date)-parseDate(a.date));
  rows.forEach(e=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${new Date(e.date).toLocaleDateString('pt-BR')}</td>
      <td>${fmtBR(e.value)}</td>
      <td>${e.cat}</td>
      <td>${e.method}</td>
      <td>${e.note||''}</td>
      <td><button class="danger" onclick="removeExp('${e.id}')">Excluir</button></td>`;
    tbody.appendChild(tr);
  });
}

function renderGoals(){
  const tbody=document.querySelector('#tbl-goals tbody'); tbody.innerHTML='';
  state.goals.forEach(g=>{
    const monthsLeft=Math.max(1, monthDiff(new Date(), parseDate(g.date)));
    const remain=Math.max(0, g.target - g.saved);
    const needPerMonth=remain/monthsLeft;
    const capacity = Math.max(0, (state.rules.income||0) - (state.rules.limitSpend||0));
    const onTrack = needPerMonth<=capacity;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${g.name}</td>
      <td>${fmtBR(g.target)}</td>
      <td>${new Date(g.date).toLocaleDateString('pt-BR')}</td>
      <td>${fmtBR(needPerMonth)}</td>
      <td>${fmtBR(g.saved)} (${((g.saved/g.target)*100||0).toFixed(0)}%)</td>
      <td>
        <button class="success" onclick="addGoalSaving('${g.id}')">Registrar poupança</button>
        <button onclick="selectGoal('${g.id}')">Plano</button>
        <button class="ghost" onclick="editGoal('${g.id}')">Editar</button>
        <button class="danger" onclick="removeGoal('${g.id}')">Remover</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function selectGoal(id){
  const g=state.goals.find(x=>x.id===id); if(!g) return;
  const plan = buildGoalPlan(g);
  document.getElementById('goal-plan').innerHTML = plan;
  switchTab('metas');
}

function buildGoalPlan(g){
  const monthsLeft=Math.max(1, monthDiff(new Date(), parseDate(g.date)));
  const remain=Math.max(0, g.target - g.saved);
  const needPerMonth=remain/monthsLeft;

  // capacidade: renda - (mínimo dívidas + essenciais médios)
  const mkey=monthKey(new Date());
  const monthExps = state.expenses.filter(e=>monthKey(parseDate(e.date))===mkey);
  const essentials = monthExps.filter(e=>['Contas Fixas','Alimentação','Saúde'].includes(e.cat))
                    .reduce((s,e)=>s+e.value,0);
  const minDebts = state.debts.filter(d=>d.status!=='settled').reduce((s,d)=>s+minPayment(d),0);
  const capacity = Math.max(0,(state.rules.income||0) - (essentials + minDebts));

  // dívidas a priorizar
  const priorities = prioritizeDebts(state.debts);

  // sugestões de corte: Top 3 categorias (Lazer/Restaurantes/Transporte/Outros)
  const cats = summarizeByCategory(monthExps);
  const candidates = Object.entries(cats)
    .filter(([c])=>['Lazer','Alimentação','Transporte','Outros'].includes(c))
    .sort((a,b)=>b[1]-a[1]).slice(0,3);

  const delta = Math.max(0, needPerMonth - capacity);
  const suggestions = delta>0? `<li>Corte sugerido total: <b>${fmtBR(delta)}</b>/mês nas categorias: ${candidates.map(([c,v])=>`${c} (${fmtBR(Math.min(v,delta))})`).join(', ')}.</li>`: `<li>Capacidade atual cobre a poupança necessária.</li>`;

  return `
    <p><b>${g.name}</b> — precisa poupar <b>${fmtBR(needPerMonth)}</b>/mês por ${monthsLeft} mês(es).</p>
    <ul class="clean">
      <li>Priorize quitar na ordem: ${priorities.map(d=>`${d.creditor} (${(d.interest*100).toFixed(1)}% a.m.)`).join(' → ')||'—'}</li>
      ${suggestions}
      <li>Ajuste o limite de gastos em “Renda & Regras” para reforçar a poupança.</li>
    </ul>
  `;
}

function summarizeByCategory(exps){
  const m={}; exps.forEach(e=>{ m[e.cat]=(m[e.cat]||0)+e.value; }); return m;
}

/*** ===== Gráficos (Canvas simples) ===== ***/
function drawSpendVsIncome(monthExps, income, limit){
  const spend = monthExps.reduce((s,e)=>s+e.value,0);
  const data=[['Renda',income,'#2563eb'],['Gastos',spend,'#dc2626'],['Limite',limit,'#f59e0b']];
  drawBars('chart-spend', data);
  document.getElementById('spend-legend').textContent = `Renda: ${fmtBR(income)} • Gastos: ${fmtBR(spend)} • Limite: ${fmtBR(limit)}`;
}
function drawCatsChart(monthExps){
  const cats=summarizeByCategory(monthExps);
  const entries=Object.entries(cats).sort((a,b)=>b[1]-a[1]).slice(0,6);
  drawBars('chart-cats', entries.map(([k,v],i)=>[k,v,['#60a5fa','#34d399','#fbbf24','#f87171','#c084fc','#94a3b8'][i%6]]), true);
  document.getElementById('cats-legend').textContent = entries.length? entries.map(([k,v])=>`${k}: ${fmtBR(v)}`).join(' • '):'Sem gastos no mês.';
}
function drawProjectionChart(series){
  const labels=series.map(s=>s.label);
  const values=series.map(s=>s.value);
  drawLine('chart-proj', labels, values, '#34d399');
  document.getElementById('proj-legend').textContent = `Saldo atual → ${labels[labels.length-1]}: ${fmtBR(values[values.length-1])}`;
}
function drawBars(id, data, horiz=false){
  const c=document.getElementById(id); const ctx=c.getContext('2d');
  const w=c.width=c.clientWidth, h=c.height=c.clientHeight;
  ctx.clearRect(0,0,w,h);
  const max=Math.max(1,...data.map(d=>d[1]));
  const pad=30, gap=20;
  const n=data.length;
  const barW = horiz? (h-2*pad - (n-1)*gap)/n : (w-2*pad - (n-1)*gap)/n;
  data.forEach((d,i)=>{
    const v=d[1], color=d[2]||'#60a5fa';
    ctx.fillStyle=color;
    if(horiz){
      const x=pad, y=pad+i*(barW+gap);
      const len=(w-2*pad)*(v/max);
      roundRect(ctx,x,y,len,barW,8,true);
      ctx.fillStyle='#cbd5e1'; ctx.fillText(`${d[0]} (${fmtBR(v)})`, x+6, y+barW/1.6);
    }else{
      const x=pad+i*(barW+gap), y=h-pad, len=(h-2*pad)*(v/max);
      roundRect(ctx,x,y-len,barW,len,8,true);
      ctx.fillStyle='#cbd5e1'; ctx.fillText(d[0], x, y+12);
    }
  });
}
function drawLine(id, labels, values, stroke='#34d399'){
  const c=document.getElementById(id); const ctx=c.getContext('2d');
  const w=c.width=c.clientWidth, h=c.height=c.clientHeight; ctx.clearRect(0,0,w,h);
  const pad=30; const max=Math.max(...values,1), min=Math.min(...values,0);
  ctx.strokeStyle=stroke; ctx.lineWidth=2; ctx.beginPath();
  values.forEach((v,i)=>{
    const x=pad + (w-2*pad)*(i/(values.length-1));
    const y=h-pad - (h-2*pad)*((v-min)/(max-min||1));
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  // labels
  ctx.fillStyle='#cbd5e1'; ctx.textAlign='center';
  labels.forEach((lb,i)=>{
    const x=pad + (w-2*pad)*(i/(labels.length-1)); ctx.fillText(lb, x, h-8);
  });
}
function roundRect(ctx,x,y,w,h,r,fill){
  if(w<0){x+=w;w*=-1}
  if(h<0){y+=h;h*=-1}
  r=Math.min(r,w/2,h/2); ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); if(fill) ctx.fill();
}

/*** ===== Exportar / Importar / Reset ===== ***/
document.getElementById('btn-export').onclick=()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download = 'finapp-backup.json'; a.click(); URL.revokeObjectURL(a.href);
};
document.getElementById('btn-import').onclick=()=>{
  const f=document.getElementById('file-import').files[0];
  if(!f) return alert('Selecione um arquivo JSON.');
  const reader=new FileReader();
  reader.onload=()=>{ try{ const data=JSON.parse(reader.result);
    Object.assign(state, data); save(); render(); alert('Importado com sucesso.');
  }catch(e){ alert('Arquivo inválido.'); } };
  reader.readAsText(f);
};
document.getElementById('btn-reset').onclick=()=>{ if(confirm('Apagar todos os dados?')){ localStorage.removeItem(KEY); location.reload(); } };

/*** ===== Toast simples ===== ***/
function toast(msg){
  const el=document.createElement('div'); el.textContent=msg;
  el.style.position='fixed'; el.style.bottom='16px'; el.style.right='16px';
  el.style.background='#111827'; el.style.border='1px solid #1f2937';
  el.style.padding='10px 14px'; el.style.borderRadius='8px'; el.style.zIndex='999';
  document.body.appendChild(el); setTimeout(()=>el.remove(),2000);
}

/*** ===== Inicialização ===== ***/
function initTables(){ renderDebts(); renderExpenses(); renderGoals(); }
window.addEventListener('load',()=>{ render(); initTables(); });

</script>
</body>
</html>
